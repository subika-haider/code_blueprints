<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Hospital Analytics Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --success-color: #43e97b;
            --warning-color: #fa709a;
            --danger-color: #dc3545;
            --dark-bg: #1a1a2e;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-dark: #2c3e50;
            --text-light: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }

        .dashboard-title {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .dashboard-subtitle {
            font-size: 1.2rem;
            color: var(--text-dark);
            opacity: 0.8;
        }

        .controls-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: var(--text-dark);
        }

        .control-group select, .control-group input, .btn {
            padding: 10px 15px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            background: white;
            color: var(--text-dark);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #38d9a9);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #ffc947);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #e74c3c);
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
        }

        .stat-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-dark);
            display: block;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-dark);
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-change {
            font-size: 0.8rem;
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        .stat-change.positive {
            background: rgba(67, 233, 123, 0.2);
            color: var(--success-color);
        }

        .stat-change.negative {
            background: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-icon {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .chart-options {
            display: flex;
            gap: 10px;
        }

        .chart-btn {
            padding: 5px 10px;
            border: 1px solid var(--primary-color);
            background: transparent;
            color: var(--primary-color);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .chart-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .chart-content {
            height: 400px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .chart-content canvas {
            width: 100% !important;
            height: 100% !important;
            max-height: 400px;
        }

        .large-chart {
            grid-column: 1 / -1;
        }

        .large-chart .chart-content {
            height: 500px;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            pointer-events: none;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .room-flow-viz {
            height: 600px;
            position: relative;
            background: radial-gradient(circle at center, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            border-radius: 15px;
            overflow: hidden;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            filter: brightness(1.2);
        }

        .link {
            fill: none;
            stroke-opacity: 0.6;
            transition: all 0.3s ease;
        }

        .link:hover {
            stroke-opacity: 1;
            stroke-width: 3px;
        }

        .heatmap-container {
            height: 450px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            border-radius: 15px;
            padding: 20px;
        }

        .alerts-panel {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid;
            animation: slideInLeft 0.5s ease;
        }

        .alert-critical {
            background: rgba(220, 53, 69, 0.1);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .alert-warning {
            background: rgba(250, 112, 154, 0.1);
            border-color: var(--warning-color);
            color: #d68910;
        }

        .alert-info {
            background: rgba(102, 126, 234, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .real-time-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: var(--success-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-right: 8px;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(67, 233, 123, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(67, 233, 123, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(67, 233, 123, 0);
            }
        }

        .data-quality-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .quality-high {
            background: rgba(67, 233, 123, 0.2);
            color: var(--success-color);
        }

        .quality-medium {
            background: rgba(250, 112, 154, 0.2);
            color: var(--warning-color);
        }

        .quality-low {
            background: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }

        .export-panel {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            text-align: center;
        }

        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .dashboard-title {
                font-size: 2rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-panel {
                flex-direction: column;
                align-items: stretch;
            }
            
            .export-buttons {
                flex-direction: column;
            }
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-dark);
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">üè• Advanced Hospital Analytics</h1>
            <p class="dashboard-subtitle">Real-time insights into patient care and hospital operations</p>
            <div class="real-time-indicator"></div>
            <span>Live Data Feed Active</span>
        </div>

        <!-- Alerts Panel -->
        <div class="alerts-panel">
            <h3>üö® System Alerts</h3>
            <div id="alertsContainer">
                <div class="alert alert-critical">
                    <strong>Critical:</strong> ICU capacity at 95% - Consider activating overflow protocols
                </div>
                <div class="alert alert-warning">
                    <strong>Warning:</strong> Lab processing times exceeding normal ranges in evening shift
                </div>
                <div class="alert alert-info">
                    <strong>Info:</strong> New patient admission protocols activated for infectious disease screening
                </div>
            </div>
        </div>

        <!-- Controls Panel -->
        <div class="controls-panel">
            <div class="control-group">
                <label>üè¢ Department:</label>
                <select id="departmentFilter">
                    <option value="all">All Departments</option>
                    <option value="emergency">Emergency Department</option>
                    <option value="icu">Intensive Care</option>
                    <option value="surgery">Surgery</option>
                    <option value="cardiac">Cardiac Unit</option>
                    <option value="neurology">Neurology</option>
                    <option value="medicine">General Medicine</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>üìÖ Time Range:</label>
                <select id="timeRange">
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                    <option value="90d">Last 90 Days</option>
                    <option value="1y">Last Year</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>üìä Data Source:</label>
                <input type="file" id="dataUpload" accept=".json,.csv" style="display: none;">
                <button class="btn" onclick="document.getElementById('dataUpload').click()">Upload Data</button>
            </div>
            
            <div class="control-group">
                <button class="btn btn-success" onclick="refreshDashboard()">üîÑ Refresh</button>
                <button class="btn btn-warning" onclick="toggleAutoRefresh()">‚è∞ Auto-Refresh</button>
            </div>
        </div>

        <!-- Key Statistics -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <span class="stat-number" id="totalPatients">0</span>
                <div class="stat-label">Active Patients</div>
                <div class="stat-change positive">+5.2% from yesterday</div>
                <div class="data-quality-indicator quality-high">High Quality</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üè•</div>
                <span class="stat-number" id="totalAdmissions">0</span>
                <div class="stat-label">Total Admissions</div>
                <div class="stat-change positive">+2.1% from last week</div>
                <div class="data-quality-indicator quality-high">High Quality</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <span class="stat-number" id="avgLOS">0</span>
                <div class="stat-label">Avg Length of Stay</div>
                <div class="stat-change negative">-0.8% from last month</div>
                <div class="data-quality-indicator quality-medium">Medium Quality</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üõèÔ∏è</div>
                <span class="stat-number" id="bedOccupancy">0%</span>
                <div class="stat-label">Bed Occupancy</div>
                <div class="stat-change positive">+1.5% from yesterday</div>
                <div class="data-quality-indicator quality-high">High Quality</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üíî</div>
                <span class="stat-number" id="mortalityRate">0%</span>
                <div class="stat-label">Mortality Rate</div>
                <div class="stat-change negative">-0.3% from last month</div>
                <div class="data-quality-indicator quality-high">High Quality</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚ö°</div>
                <span class="stat-number" id="avgResponseTime">0</span>
                <div class="stat-label">Avg Response Time (min)</div>
                <div class="stat-change positive">-15% from last week</div>
                <div class="data-quality-indicator quality-medium">Medium Quality</div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">
                    <span class="chart-icon">üìà</span>
                    Key Performance Indicators
                </div>
            </div>
            <div class="performance-metrics">
                <div class="metric-card">
                    <div class="metric-value" id="emergencyWaitTime">8.5</div>
                    <div class="metric-label">Emergency Wait Time (min)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="surgeryUtilization">87%</div>
                    <div class="metric-label">Surgery Room Utilization</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="labTurnaround">2.3</div>
                    <div class="metric-label">Lab Turnaround (hours)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="patientSatisfaction">4.7</div>
                    <div class="metric-label">Patient Satisfaction</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="readmissionRate">5.2%</div>
                    <div class="metric-label">30-Day Readmission</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="staffEfficiency">92%</div>
                    <div class="metric-label">Staff Efficiency</div>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Patient Demographics -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="chart-icon">üë•</span>
                        Patient Demographics
                    </div>
                    <div class="chart-options">
                        <button class="chart-btn" onclick="toggleChartType('demographics', 'pie')">Pie</button>
                        <button class="chart-btn" onclick="toggleChartType('demographics', 'bar')">Bar</button>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="demographicsChart"></canvas>
                </div>
            </div>

            <!-- Age Distribution -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="chart-icon">üìä</span>
                        Age Distribution
                    </div>
                    <div class="chart-options">
                        <button class="chart-btn" onclick="exportChart('ageChart')">Export</button>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>

            <!-- Admission Types -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="chart-icon">üö™</span>
                        Admission Types
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="admissionTypesChart"></canvas>
                </div>
            </div>

            <!-- Length of Stay Analysis -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="chart-icon">‚è±Ô∏è</span>
                        Length of Stay by Department
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="losChart"></canvas>
                </div>
            </div>

            <!-- Real-time Vital Signs -->
            <div class="chart-container large-chart">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="chart-icon">üìà</span>
                        Real-time Vital Signs Monitoring
                    </div>
                    <div class="chart-options">
                        <button class="chart-btn" onclick="toggleVitalSign('heartRate')">Heart Rate</button>
                        <button class="chart-btn" onclick="toggleVitalSign('bloodPressure')">Blood Pressure</button>
                        <button class="chart-btn" onclick="toggleVitalSign('temperature')">Temperature</button>
                    </div>
                </div>
                <div class="chart-content">
                    <div id="vitalSignsChart"></div>
                </div>
            </div>

            <!-- Room Flow Visualization -->
            <div class="chart-container large-chart">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="chart-icon">üîÑ</span>
                        Patient Flow Between Departments
                    </div>
                    <div class="chart-options">
                        <button class="chart-btn" onclick="animateFlow()">Animate</button>
                        <button class="chart-btn" onclick="resetFlow()">Reset</button>
                    </div>
                </div>
                <div class="chart-content room-flow-viz" id="flowVisualization">
                </div>
            </div>

            <!-- Lab Test Heatmap -->
            <div class="chart-container large-chart">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="chart-icon">üß™</span>
                        Lab Test Activity Heatmap
                    </div>
                </div>
                <div class="chart-content heatmap-container">
                    <div id="labHeatmap"></div>
                </div>
            </div>

            <!-- ICU Occupancy -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="chart-icon">üè•</span>
                        ICU Occupancy by Unit
                    </div>
                </div>
                <div class="chart-content">
                    <div id="icuOccupancyChart"></div>
                </div>
            </div>

            <!-- Mortality Analysis -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="chart-icon">üíî</span>
                        Mortality Rates by Department
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="mortalityChart"></canvas>
                </div>
            </div>

            <!-- Seasonal Trends -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="chart-icon">üìÖ</span>
                        Seasonal Admission Patterns
                    </div>
                </div>
                <div class="chart-content">
                    <div id="seasonalChart"></div>
                </div>
            </div>

            <!-- Resource Utilization -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="chart-icon">‚ö°</span>
                        Resource Utilization Radar
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="resourceChart"></canvas>
                </div>
            </div>

            <!-- Diagnosis Distribution -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="chart-icon">ü©∫</span>
                        Top Diagnosis Categories
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="diagnosisChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Export Panel -->
        <div class="export-panel">
            <h3>üìä Export & Reports</h3>
            <div class="export-buttons">
                <button class="btn" onclick="exportToPDF()">üìÑ Export to PDF</button>
                <button class="btn btn-success" onclick="exportToExcel()">üìä Export to Excel</button>
                <button class="btn btn-warning" onclick="generateReport()">üìã Generate Report</button>
                <button class="btn btn-danger" onclick="exportRawData()">üíæ Export Raw Data</button>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <script>
        // Global variables
        let hospitalData = {};
        let autoRefreshInterval = null;
        let chartInstances = {};
        let currentFilters = {
            department: 'all',
            timeRange: '24h'
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            loadSampleData();
            setupEventListeners();
            startAutoRefresh();
        });

        function initializeDashboard() {
            console.log('Initializing Advanced Hospital Dashboard...');
            showLoadingState();
            
            // Initialize all charts
            setTimeout(() => {
                createAllCharts();
                updateStatistics();
                hideLoadingState();
            }, 1000);
        }

        function loadSampleData() {
            // Generate comprehensive sample data
            hospitalData = {
                patients: generatePatientData(2500),
                admissions: generateAdmissionData(3000),
                icuStays: generateICUData(800),
                transfers: generateTransferData(5000),
                labEvents: generateLabData(15000),
                chartEvents: generateVitalSignsData(20000),
                diagnoses: generateDiagnosisData(4500)
            };
            
            console.log('Sample data loaded:', hospitalData);
        }

        function generatePatientData(count) {
            const genders = ['M', 'F'];
            const races = ['WHITE', 'BLACK/AFRICAN AMERICAN', 'HISPANIC/LATINO', 'ASIAN', 'OTHER'];
            const data = [];
            
            for (let i = 0; i < count; i++) {
                data.push({
                    subject_id: 10000000 + i,
                    gender: genders[Math.floor(Math.random() * 2)],
                    anchor_age: Math.floor(Math.random() * 80) + 18,
                    anchor_year: 2011 + Math.floor(Math.random() * 3),
                    race: races[Math.floor(Math.random() * races.length)],
                    dod: Math.random() < 0.08 ? '2023-01-01' : null
                });
            }
            return data;
        }

        function generateAdmissionData(count) {
            const admissionTypes = ['URGENT', 'ELECTIVE', 'EMERGENCY', 'NEWBORN'];
            const locations = ['EMERGENCY ROOM', 'TRANSFER FROM HOSPITAL', 'CLINIC REFERRAL', 'AMBULATORY SURGERY'];
            const dischargeLocations = ['HOME', 'SKILLED NURSING FACILITY', 'HOME HEALTH CARE', 'DIED', 'REHAB/DISTINCT'];
            const data = [];
            
            for (let i = 0; i < count; i++) {
                const los = Math.random() * 25 + 1;
                const admitDate = new Date(2011 + Math.random() * 3, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28));
                data.push({
                    subject_id: 10000000 + Math.floor(Math.random() * 2500),
                    hadm_id: 20000000 + i,
                    admission_type: admissionTypes[Math.floor(Math.random() * admissionTypes.length)],
                    admission_location: locations[Math.floor(Math.random() * locations.length)],
                    discharge_location: dischargeLocations[Math.floor(Math.random() * dischargeLocations.length)],
                    admittime: admitDate,
                    dischtime: new Date(admitDate.getTime() + los * 24 * 60 * 60 * 1000),
                    los: los,
                    hospital_expire_flag: Math.random() < 0.05 ? 1 : 0
                });
            }
            return data;
        }

        function generateICUData(count) {
            const careUnits = ['MICU', 'SICU', 'CCU', 'CVICU', 'Neuro ICU', 'Trauma ICU', 'TSICU'];
            const data = [];
            
            for (let i = 0; i < count; i++) {
                const los = Math.random() * 20 + 0.5;
                data.push({
                    subject_id: 10000000 + Math.floor(Math.random() * 2500),
                    hadm_id: 20000000 + Math.floor(Math.random() * 3000),
                    stay_id: 30000000 + i,
                    first_careunit: careUnits[Math.floor(Math.random() * careUnits.length)],
                    last_careunit: careUnits[Math.floor(Math.random() * careUnits.length)],
                    los: los,
                    intime: new Date(2011 + Math.random() * 3, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28)),
                    outtime: new Date()
                });
            }
            return data;
        }

        function generateTransferData(count) {
            const careUnits = ['Emergency Department', 'MICU', 'SICU', 'CCU', 'Surgery', 'Neurology', 'Cardiology', 'Medicine', 'Orthopedics'];
            const data = [];
            
            for (let i = 0; i < count; i++) {
                data.push({
                    subject_id: 10000000 + Math.floor(Math.random() * 2500),
                    hadm_id: 20000000 + Math.floor(Math.random() * 3000),
                    careunit: careUnits[Math.floor(Math.random() * careUnits.length)],
                    prev_careunit: careUnits[Math.floor(Math.random() * careUnits.length)],
                    intime: new Date(2011 + Math.random() * 3, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28)),
                    outtime: new Date()
                });
            }
            return data;
        }

        function generateLabData(count) {
            const labItems = ['Hemoglobin', 'White Blood Cell', 'Platelet', 'Glucose', 'Creatinine', 'Sodium', 'Potassium', 'BUN'];
            const data = [];
            
            for (let i = 0; i < count; i++) {
                const charttime = new Date(2011 + Math.random() * 3, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28), Math.floor(Math.random() * 24));
                data.push({
                    subject_id: 10000000 + Math.floor(Math.random() * 2500),
                    hadm_id: 20000000 + Math.floor(Math.random() * 3000),
                    itemid: Math.floor(Math.random() * 1000) + 50000,
                    item_name: labItems[Math.floor(Math.random() * labItems.length)],
                    charttime: charttime,
                    valuenum: Math.random() * 200 + 10,
                    hour: charttime.getHours(),
                    day_of_week: charttime.getDay()
                });
            }
            return data;
        }

        function generateVitalSignsData(count) {
            const vitalItems = ['Heart Rate', 'Blood Pressure Systolic', 'Blood Pressure Diastolic', 'Respiratory Rate', 'Temperature', 'SpO2'];
            const data = [];
            
            for (let i = 0; i < count; i++) {
                const charttime = new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000);
                let value;
                const itemName = vitalItems[Math.floor(Math.random() * vitalItems.length)];
                
                // Generate realistic values based on vital sign type
                switch(itemName) {
                    case 'Heart Rate':
                        value = 60 + Math.random() * 40;
                        break;
                    case 'Blood Pressure Systolic':
                        value = 100 + Math.random() * 60;
                        break;
                    case 'Blood Pressure Diastolic':
                        value = 60 + Math.random() * 40;
                        break;
                    case 'Respiratory Rate':
                        value = 12 + Math.random() * 8;
                        break;
                    case 'Temperature':
                        value = 97 + Math.random() * 4;
                        break;
                    case 'SpO2':
                        value = 95 + Math.random() * 5;
                        break;
                    default:
                        value = Math.random() * 100;
                }
                
                data.push({
                    subject_id: 10000000 + Math.floor(Math.random() * 2500),
                    stay_id: 30000000 + Math.floor(Math.random() * 800),
                    itemid: Math.floor(Math.random() * 1000) + 220000,
                    item_name: itemName,
                    charttime: charttime,
                    valuenum: value
                });
            }
            return data;
        }

        function generateDiagnosisData(count) {
            const diagnoses = [
                'Acute Myocardial Infarction', 'Heart Failure', 'Pneumonia', 'Septicemia',
                'Respiratory Failure', 'Acute Kidney Failure', 'Diabetes Mellitus', 'Cardiac Dysrhythmias',
                'Stroke', 'COPD', 'Hypertension', 'Fracture', 'Gastrointestinal Bleeding'
            ];
            const data = [];
            
            for (let i = 0; i < count; i++) {
                data.push({
                    subject_id: 10000000 + Math.floor(Math.random() * 2500),
                    hadm_id: 20000000 + Math.floor(Math.random() * 3000),
                    icd_code: Math.floor(Math.random() * 999) + 100,
                    diagnosis: diagnoses[Math.floor(Math.random() * diagnoses.length)],
                    seq_num: Math.floor(Math.random() * 10) + 1
                });
            }
            return data;
        }

        function createAllCharts() {
            createDemographicsChart();
            createAgeDistributionChart();
            createAdmissionTypesChart();
            createLOSChart();
            createVitalSignsChart();
            createFlowVisualization();
            createLabHeatmap();
            createICUOccupancyChart();
            createMortalityChart();
            createSeasonalChart();
            createResourceChart();
            createDiagnosisChart();
        }

        function createDemographicsChart() {
            const ctx = document.getElementById('demographicsChart').getContext('2d');
            const genderCounts = hospitalData.patients.reduce((acc, patient) => {
                acc[patient.gender] = (acc[patient.gender] || 0) + 1;
                return acc;
            }, {});

            chartInstances.demographics = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(genderCounts).map(g => g === 'M' ? 'Male' : 'Female'),
                    datasets: [{
                        data: Object.values(genderCounts),
                        backgroundColor: ['#667eea', '#764ba2'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
        }

        function createAgeDistributionChart() {
            const ctx = document.getElementById('ageChart').getContext('2d');
            const ageGroups = {};
            
            hospitalData.patients.forEach(patient => {
                const ageGroup = Math.floor(patient.anchor_age / 10) * 10;
                const label = `${ageGroup}-${ageGroup + 9}`;
                ageGroups[label] = (ageGroups[label] || 0) + 1;
            });

            chartInstances.age = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ageGroups).sort(),
                    datasets: [{
                        label: 'Number of Patients',
                        data: Object.values(ageGroups),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1.2,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createAdmissionTypesChart() {
            const ctx = document.getElementById('admissionTypesChart').getContext('2d');
            const admissionCounts = hospitalData.admissions.reduce((acc, admission) => {
                acc[admission.admission_type] = (acc[admission.admission_type] || 0) + 1;
                return acc;
            }, {});

            chartInstances.admissions = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(admissionCounts),
                    datasets: [{
                        data: Object.values(admissionCounts),
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        function createLOSChart() {
            const ctx = document.getElementById('losChart').getContext('2d');
            const unitLOS = {};
            
            hospitalData.transfers.forEach(transfer => {
                if (!unitLOS[transfer.careunit]) {
                    unitLOS[transfer.careunit] = [];
                }
                const admission = hospitalData.admissions.find(adm => adm.hadm_id === transfer.hadm_id);
                if (admission) {
                    unitLOS[transfer.careunit].push(admission.los);
                }
            });

            const avgLOS = Object.keys(unitLOS).map(unit => ({
                unit,
                avgLOS: unitLOS[unit].reduce((sum, los) => sum + los, 0) / unitLOS[unit].length
            })).sort((a, b) => b.avgLOS - a.avgLOS);

            chartInstances.los = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: avgLOS.map(item => item.unit),
                    datasets: [{
                        label: 'Average Length of Stay (days)',
                        data: avgLOS.map(item => item.avgLOS),
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderColor: '#764ba2',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createVitalSignsChart() {
            const timeData = hospitalData.chartEvents
                .filter(event => event.charttime > new Date(Date.now() - 24 * 60 * 60 * 1000))
                .sort((a, b) => a.charttime - b.charttime);

            const heartRateData = timeData.filter(d => d.item_name === 'Heart Rate');
            const bpData = timeData.filter(d => d.item_name === 'Blood Pressure Systolic');
            const tempData = timeData.filter(d => d.item_name === 'Temperature');

            const traces = [
                {
                    x: heartRateData.map(d => d.charttime),
                    y: heartRateData.map(d => d.valuenum),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Heart Rate (bpm)',
                    line: { color: '#667eea', width: 3 },
                    marker: { size: 4 }
                },
                {
                    x: bpData.map(d => d.charttime),
                    y: bpData.map(d => d.valuenum),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Blood Pressure (mmHg)',
                    line: { color: '#764ba2', width: 3 },
                    marker: { size: 4 },
                    yaxis: 'y2'
                },
                {
                    x: tempData.map(d => d.charttime),
                    y: tempData.map(d => d.valuenum),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Temperature (¬∞F)',
                    line: { color: '#f093fb', width: 3 },
                    marker: { size: 4 },
                    yaxis: 'y3'
                }
            ];

            const layout = {
                title: false,
                xaxis: { 
                    title: 'Time',
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.1)'
                },
                yaxis: { 
                    title: 'Heart Rate (bpm)',
                    side: 'left',
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.1)'
                },
                yaxis2: {
                    title: 'Blood Pressure (mmHg)',
                    overlaying: 'y',
                    side: 'right'
                },
                yaxis3: {
                    title: 'Temperature (¬∞F)',
                    overlaying: 'y',
                    side: 'right',
                    position: 0.95
                },
                margin: { t: 30, r: 80 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.newPlot('vitalSignsChart', traces, layout, {responsive: true});
        }

        function createFlowVisualization() {
            const svg = d3.select('#flowVisualization')
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', '0 0 800 500');

            const units = ['Emergency', 'Surgery', 'ICU', 'Medicine', 'Cardiology', 'Neurology'];
            const nodes = units.map((unit, i) => ({
                id: unit,
                x: (i % 3) * 250 + 150,
                y: Math.floor(i / 3) * 200 + 150,
                value: Math.floor(Math.random() * 150) + 50,
                transfers: Math.floor(Math.random() * 100) + 20
            }));

            const links = [];
            for (let i = 0; i < nodes.length; i++) {
                for (let j = 0; j < nodes.length; j++) {
                    if (i !== j && Math.random() < 0.4) {
                        links.push({
                            source: nodes[i],
                            target: nodes[j],
                            value: Math.floor(Math.random() * 30) + 5
                        });
                    }
                }
            }

            // Add gradient definitions
            const defs = svg.append('defs');
            const gradient = defs.append('linearGradient')
                .attr('id', 'linkGradient')
                .attr('gradientUnits', 'userSpaceOnUse');
            
            gradient.append('stop').attr('offset', '0%').attr('stop-color', '#667eea');
            gradient.append('stop').attr('offset', '100%').attr('stop-color', '#764ba2');

            // Draw links
            svg.selectAll('.link')
                .data(links)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y)
                .attr('stroke', 'url(#linkGradient)')
                .attr('stroke-width', d => Math.sqrt(d.value) * 2)
                .attr('stroke-opacity', 0.6)
                .attr('marker-end', 'url(#arrowhead)');

            // Add arrow markers
            defs.append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '-0 -5 10 10')
                .attr('refX', 13)
                .attr('refY', 0)
                .attr('orient', 'auto')
                .attr('markerWidth', 13)
                .attr('markerHeight', 13)
                .attr('xoverflow', 'visible')
                .append('svg:path')
                .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                .attr('fill', '#764ba2')
                .style('stroke', 'none');

            // Draw nodes
            const nodeGroups = svg.selectAll('.node-group')
                .data(nodes)
                .enter()
                .append('g')
                .attr('class', 'node-group')
                .attr('transform', d => `translate(${d.x}, ${d.y})`);

            nodeGroups.append('circle')
                .attr('class', 'node')
                .attr('r', d => Math.sqrt(d.value) * 3)
                .attr('fill', '#667eea')
                .attr('stroke', '#fff')
                .attr('stroke-width', 3)
                .on('mouseover', function(event, d) {
                    d3.select(this).transition().duration(200).attr('r', Math.sqrt(d.value) * 3.5);
                    showTooltip(event, `${d.id}<br/>Patients: ${d.value}<br/>Transfers: ${d.transfers}`);
                })
                .on('mouseout', function(event, d) {
                    d3.select(this).transition().duration(200).attr('r', Math.sqrt(d.value) * 3);
                    hideTooltip();
                });

            // Add labels
            nodeGroups.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '.35em')
                .attr('fill', 'white')
                .attr('font-weight', 'bold')
                .attr('font-size', '12px')
                .text(d => d.id);
        }

        function createLabHeatmap() {
            const hours = Array.from({length: 24}, (_, i) => i);
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            // Process lab data to create heatmap
            const heatmapData = [];
            days.forEach((day, dayIndex) => {
                hours.forEach(hour => {
                    const count = hospitalData.labEvents.filter(event => 
                        event.hour === hour && event.day_of_week === dayIndex
                    ).length;
                    heatmapData.push({
                        day: dayIndex,
                        hour: hour,
                        value: count || Math.floor(Math.random() * 50) + 10
                    });
                });
            });

            const zValues = [];
            for (let day = 0; day < 7; day++) {
                const dayValues = [];
                for (let hour = 0; hour < 24; hour++) {
                    const dataPoint = heatmapData.find(d => d.day === day && d.hour === hour);
                    dayValues.push(dataPoint ? dataPoint.value : 0);
                }
                zValues.push(dayValues);
            }

            const trace = {
                z: zValues,
                x: hours,
                y: days,
                type: 'heatmap',
                colorscale: [
                    [0, '#f7fbff'],
                    [0.2, '#deebf7'],
                    [0.4, '#c6dbef'],
                    [0.6, '#9ecae1'],
                    [0.8, '#6baed6'],
                    [1, '#3182bd']
                ],
                showscale: true,
                colorbar: {
                    title: 'Number of Tests'
                }
            };

            const layout = {
                title: false,
                xaxis: { 
                    title: 'Hour of Day',
                    showgrid: false
                },
                yaxis: { 
                    title: 'Day of Week',
                    showgrid: false
                },
                margin: { t: 30 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.newPlot('labHeatmap', [trace], layout, {responsive: true});
        }

        function createICUOccupancyChart() {
            const icuData = hospitalData.icuStays.map(stay => ({
                x: stay.first_careunit,
                y: stay.los
            }));

            const careUnits = [...new Set(icuData.map(d => d.x))];
            const traces = careUnits.map(unit => ({
                y: icuData.filter(d => d.x === unit).map(d => d.y),
                type: 'box',
                name: unit,
                boxpoints: 'outliers'
            }));

            const layout = {
                title: false,
                yaxis: { title: 'Length of Stay (days)' },
                margin: { t: 30 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                showlegend: false
            };

            Plotly.newPlot('icuOccupancyChart', traces, layout, {responsive: true});
        }

        function createMortalityChart() {
            const ctx = document.getElementById('mortalityChart').getContext('2d');
            const mortalityByUnit = {};
            
            hospitalData.transfers.forEach(transfer => {
                if (!mortalityByUnit[transfer.careunit]) {
                    mortalityByUnit[transfer.careunit] = { total: 0, deaths: 0 };
                }
                mortalityByUnit[transfer.careunit].total++;
                
                const admission = hospitalData.admissions.find(adm => adm.hadm_id === transfer.hadm_id);
                if (admission && admission.hospital_expire_flag === 1) {
                    mortalityByUnit[transfer.careunit].deaths++;
                }
            });

            const mortalityRates = Object.keys(mortalityByUnit).map(unit => ({
                unit,
                rate: (mortalityByUnit[unit].deaths / mortalityByUnit[unit].total) * 100
            }));

            chartInstances.mortality = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: mortalityRates.map(item => item.unit),
                    datasets: [{
                        label: 'Mortality Rate (%)',
                        data: mortalityRates.map(item => item.rate),
                        backgroundColor: 'rgba(220, 53, 69, 0.8)',
                        borderColor: '#dc3545',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 15,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createSeasonalChart() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const monthlyData = months.map((month, index) => {
                const admissions = hospitalData.admissions.filter(adm => 
                    adm.admittime.getMonth() === index
                ).length;
                const emergencyAdmissions = hospitalData.admissions.filter(adm => 
                    adm.admittime.getMonth() === index && adm.admission_type === 'EMERGENCY'
                ).length;
                
                return {
                    month,
                    admissions: admissions || Math.floor(Math.random() * 100) + 80,
                    emergencyAdmissions: emergencyAdmissions || Math.floor(Math.random() * 50) + 30
                };
            });

            const admissionsTrace = {
                x: months,
                y: monthlyData.map(d => d.admissions),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Total Admissions',
                line: { color: '#667eea', width: 3 },
                marker: { size: 8 }
            };

            const emergencyTrace = {
                x: months,
                y: monthlyData.map(d => d.emergencyAdmissions),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Emergency Admissions',
                line: { color: '#dc3545', width: 3 },
                marker: { size: 8 }
            };

            const layout = {
                title: false,
                xaxis: { title: 'Month' },
                yaxis: { title: 'Number of Admissions' },
                margin: { t: 30 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.newPlot('seasonalChart', [admissionsTrace, emergencyTrace], layout, {responsive: true});
        }

        function createResourceChart() {
            const ctx = document.getElementById('resourceChart').getContext('2d');
            const departments = ['Emergency', 'ICU', 'Surgery', 'Medicine', 'Cardiology', 'Neurology'];
            
            const resourceData = {
                bedOccupancy: departments.map(() => Math.floor(Math.random() * 40) + 60),
                staffUtilization: departments.map(() => Math.floor(Math.random() * 30) + 70),
                equipmentUsage: departments.map(() => Math.floor(Math.random() * 50) + 50)
            };

            chartInstances.resource = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: departments,
                    datasets: [{
                        label: 'Bed Occupancy (%)',
                        data: resourceData.bedOccupancy,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        pointBorderColor: '#667eea',
                        pointBackgroundColor: '#667eea'
                    }, {
                        label: 'Staff Utilization (%)',
                        data: resourceData.staffUtilization,
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.2)',
                        pointBorderColor: '#764ba2',
                        pointBackgroundColor: '#764ba2'
                    }, {
                        label: 'Equipment Usage (%)',
                        data: resourceData.equipmentUsage,
                        borderColor: '#f093fb',
                        backgroundColor: 'rgba(240, 147, 251, 0.2)',
                        pointBorderColor: '#f093fb',
                        pointBackgroundColor: '#f093fb'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    }
                }
            });
        }

        function createDiagnosisChart() {
            const ctx = document.getElementById('diagnosisChart').getContext('2d');
            const diagnosisCounts = hospitalData.diagnoses.reduce((acc, diagnosis) => {
                acc[diagnosis.diagnosis] = (acc[diagnosis.diagnosis] || 0) + 1;
                return acc;
            }, {});

            const topDiagnoses = Object.entries(diagnosisCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8);

            chartInstances.diagnosis = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topDiagnoses.map(([diagnosis]) => diagnosis),
                    datasets: [{
                        label: 'Number of Cases',
                        data: topDiagnoses.map(([, count]) => count),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fad0c4', '#a8edea'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateStatistics() {
            // Update main statistics
            document.getElementById('totalPatients').textContent = hospitalData.patients.length.toLocaleString();
            document.getElementById('totalAdmissions').textContent = hospitalData.admissions.length.toLocaleString();
            
            const avgLOS = hospitalData.admissions.reduce((sum, adm) => sum + adm.los, 0) / hospitalData.admissions.length;
            document.getElementById('avgLOS').textContent = avgLOS.toFixed(1);
            
            const bedOccupancy = Math.floor(Math.random() * 30) + 70;
            document.getElementById('bedOccupancy').textContent = bedOccupancy + '%';
            
            const mortalityRate = (hospitalData.admissions.filter(adm => adm.hospital_expire_flag === 1).length / hospitalData.admissions.length) * 100;
            document.getElementById('mortalityRate').textContent = mortalityRate.toFixed(1) + '%';
            
            const avgResponseTime = Math.floor(Math.random() * 10) + 5;
            document.getElementById('avgResponseTime').textContent = avgResponseTime;
        }

        function setupEventListeners() {
            // Filter change listeners
            document.getElementById('departmentFilter').addEventListener('change', function() {
                currentFilters.department = this.value;
                applyFilters();
            });

            document.getElementById('timeRange').addEventListener('change', function() {
                currentFilters.timeRange = this.value;
                applyFilters();
            });

            // Data upload listener
            document.getElementById('dataUpload').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            hospitalData = data;
                            refreshDashboard();
                            alert('Data uploaded successfully!');
                        } catch (error) {
                            alert('Error parsing uploaded data: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            });
        }

        function applyFilters() {
            // This would filter the data based on current filters
            console.log('Applying filters:', currentFilters);
            // For now, just refresh the dashboard
            refreshDashboard();
        }

        function refreshDashboard() {
            showLoadingState();
            setTimeout(() => {
                createAllCharts();
                updateStatistics();
                hideLoadingState();
            }, 500);
        }

        function toggleAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                alert('Auto-refresh disabled');
            } else {
                startAutoRefresh();
                alert('Auto-refresh enabled (30 seconds)');
            }
        }

        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                // Simulate data updates
                updateRealTimeData();
                updateStatistics();
            }, 30000); // 30 seconds
        }

        function updateRealTimeData() {
            // Add new random data points
            const newVitalSigns = generateVitalSignsData(50);
            hospitalData.chartEvents = [...hospitalData.chartEvents.slice(-500), ...newVitalSigns];
            
            // Update vital signs chart
            createVitalSignsChart();
        }

        function showLoadingState() {
            document.querySelectorAll('.chart-content').forEach(container => {
                if (!container.querySelector('.loading-spinner')) {
                    container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div>Loading...</div>';
                }
            });
        }

        function hideLoadingState() {
            document.querySelectorAll('.loading-spinner').forEach(spinner => {
                spinner.remove();
            });
        }

        function showTooltip(event, content) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = content;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY + 10 + 'px';
            tooltip.style.opacity = '1';
        }

        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.opacity = '0';
        }

        // Chart interaction functions
        function toggleChartType(chartName, type) {
            if (chartInstances[chartName]) {
                chartInstances[chartName].config.type = type;
                chartInstances[chartName].update();
            }
        }

        function exportChart(chartId) {
            const canvas = document.getElementById(chartId);
            if (canvas) {
                const link = document.createElement('a');
                link.download = chartId + '_chart.png';
                link.href = canvas.toDataURL();
                link.click();
            }
        }

        function toggleVitalSign(vitalType) {
            // This would toggle visibility of specific vital signs
            console.log('Toggling vital sign:', vitalType);
            createVitalSignsChart();
        }

        function animateFlow() {
            // Add animation to flow diagram
            const svg = d3.select('#flowVisualization svg');
            svg.selectAll('.link')
                .transition()
                .duration(2000)
                .attr('stroke-width', d => Math.sqrt(d.value) * 4)
                .transition()
                .duration(2000)
                .attr('stroke-width', d => Math.sqrt(d.value) * 2);
        }

        function resetFlow() {
            createFlowVisualization();
        }

        // Export functions
        function exportToPDF() {
            alert('PDF export functionality would be implemented here');
        }

        function exportToExcel() {
            alert('Excel export functionality would be implemented here');
        }

        function generateReport() {
            const reportData = {
                timestamp: new Date().toISOString(),
                totalPatients: hospitalData.patients.length,
                totalAdmissions: hospitalData.admissions.length,
                averageLOS: hospitalData.admissions.reduce((sum, adm) => sum + adm.los, 0) / hospitalData.admissions.length,
                mortalityRate: (hospitalData.admissions.filter(adm => adm.hospital_expire_flag === 1).length / hospitalData.admissions.length) * 100,
                filters: currentFilters
            };
            
            const reportJson = JSON.stringify(reportData, null, 2);
            const blob = new Blob([reportJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hospital_report_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportRawData() {
            const csvData = [
                ['Patient ID', 'Gender', 'Age', 'Admission Type', 'Length of Stay', 'Mortality'],
                ...hospitalData.patients.map(patient => {
                    const admission = hospitalData.admissions.find(adm => adm.subject_id === patient.subject_id);
                    return [
                        patient.subject_id,
                        patient.gender,
                        patient.anchor_age,
                        admission ? admission.admission_type : 'N/A',
                        admission ? admission.los.toFixed(2) : 'N/A',
                        admission ? admission.hospital_expire_flag : 0
                    ];
                })
            ];

            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hospital_raw_data_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey) {
                switch(event.key) {
                    case 'r':
                        event.preventDefault();
                        refreshDashboard();
                        break;
                    case 'e':
                        event.preventDefault();
                        exportRawData();
                        break;
                    case 's':
                        event.preventDefault();
                        generateReport();
                        break;
                }
            }
        });

        // Responsive chart resizing
        window.addEventListener('resize', function() {
            setTimeout(() => {
                Object.values(chartInstances).forEach(chart => {
                    if (chart && chart.resize) {
                        chart.resize();
                    }
                });
                
                // Resize Plotly charts
                const plotlyCharts = ['vitalSignsChart', 'labHeatmap', 'icuOccupancyChart', 'seasonalChart'];
                plotlyCharts.forEach(chartId => {
                    const element = document.getElementById(chartId);
                    if (element && element.data) {
                        Plotly.Plots.resize(chartId);
                    }
                });
            }, 100);
        });

        // Add some dynamic alerts
        setInterval(() => {
            const alerts = [
                { type: 'info', message: 'System performance optimal - all metrics within normal ranges' },
                { type: 'warning', message: 'High patient volume detected in Emergency Department' },
                { type: 'critical', message: 'Equipment maintenance required in Surgery Room 3' }
            ];
            
            const randomAlert = alerts[Math.floor(Math.random() * alerts.length)];
            // This would add the alert to the alerts panel
            console.log('New alert:', randomAlert);
        }, 60000); // Every minute
    </script>
</body>
</html>